<script>
const jsonURL = "https://raw.githubusercontent.com/reyvincentestayan10-afk/port-dashboard/main/dashboard_data.json";

async function fetchJSONData() {
  try {
    showToast("Fetching latest data...", "â³");

    // ğŸ”¥ Force fresh fetch (bypass browser cache)
    const fullURL = `${jsonURL}?nocache=${Date.now()}`;
    const res = await fetch(fullURL, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to fetch JSON file");

    const data = await res.json();
    console.log("âœ… Live JSON loaded:", data);

    const rampRows = data.latestRampOccupants || [];
    const incomingRows = data.incomingVessels || [];

    updateDashboard(rampRows, incomingRows);
    showToast("Dashboard updated successfully âœ…", "ğŸ“Š");
  } catch (err) {
    console.error("âŒ Fetch error:", err);
    showToast("Error loading live data", "âš ï¸");
  }
}

function updateDashboard(rampRows, incomingRows) {
  const activeBody = document.getElementById("activeBody");
  const incomingBody = document.getElementById("incomingBody");

  activeBody.innerHTML = "";
  incomingBody.innerHTML = "";

  // --- Active / Ramp Occupants ---
  rampRows.forEach(r => {
    const ramp = r["Ramp Num"] || "â€”";
    const vessel = r["Vessel Name"] || "â€”";
    const ship = r["Shipping Lines"] || "â€”";
    const lastPort = r["Last Port"] || "â€”";
    const nextPort = r["Next Port"] || "â€”";
    const eta = r["ETA"] || "â€”";
    const etd = r["ETD"] || "â€”";
    const status = r["Status"] || "â€”";

    activeBody.innerHTML += `
      <tr>
        <td class="ramp-col">${ramp}</td>
        <td>${vessel}</td>
        <td>${ship}</td>
        <td>${lastPort}</td>
        <td>${nextPort}</td>
        <td>${eta}</td>
        <td>${etd}</td>
        <td><span class="status ${status.toLowerCase().replace(/\s+/g, '-')}">${status}</span></td>
      </tr>`;
  });

  // --- Incoming Vessels ---
  incomingRows.forEach(r => {
    const vessel = r["Vessel Name"] || "â€”";
    const ship = r["Shipping Lines"] || "â€”";
    const origin = r["Last Port"] || "â€”";
    const destination = r["Next Port"] || "â€”";
    const eta = r["ETA"] || "â€”";

    incomingBody.innerHTML += `
      <tr>
        <td>${vessel}</td>
        <td>${ship}</td>
        <td>${origin}</td>
        <td>${destination}</td>
        <td>${eta}</td>
      </tr>`;
  });
}

function showToast(msg, icon) {
  const wrap = document.getElementById("toastWrap");
  const t = document.createElement("div");
  t.className = "toast show";
  t.innerHTML = `<span class="icon">${icon}</span><span class="msg">${msg}</span>`;
  wrap.appendChild(t);
  setTimeout(()=>{ t.classList.remove("show"); setTimeout(()=>t.remove(), 500); }, 3500);
}

// ğŸ” Manual refresh button
document.getElementById("refreshBtn").addEventListener("click", fetchJSONData);

// ğŸš€ Auto-load on start + every 60s
fetchJSONData();
setInterval(fetchJSONData, 60000);
</script>
