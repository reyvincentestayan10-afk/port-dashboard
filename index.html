<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMO-Matnog — Vessel Dashboard (Live)</title>

<style>
:root{
  --bg:#0b1620;--panel:#12202a;--header:#0e1823;--accent:#1f8ef1;--muted:#9fb0bd;--white:#eaf2f8;
  --loading:#2ad36a;--unloading:#2b9be6;--standby:#f2c94c;--standby-dep:#ff9a43;--anchorage:#6b7280;
  --toast-bg:rgba(12,18,24,0.95)
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--white);font-family:"Segoe UI",Roboto,Arial,sans-serif}
header{background:var(--header);padding:14px 18px;border-bottom:3px solid var(--accent);display:flex;align-items:center;justify-content:space-between}
header h1{margin:0;color:var(--accent);font-size:1.2rem}
header .controls{display:flex;gap:10px;align-items:center}
header button{background:var(--accent);border:none;padding:8px 10px;border-radius:6px;color:#021;cursor:pointer}
main{padding:12px;display:flex;flex-direction:column;gap:12px;height:calc(100% - 74px);box-sizing:border-box}
.panel{background:var(--panel);border-radius:10px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,0.5);display:flex;flex-direction:column}
.title{background:var(--header);padding:10px 14px;color:var(--accent);font-weight:700;text-transform:uppercase}
.content{padding:8px 10px;overflow:auto}
table{width:100%;border-collapse:collapse}
thead th{padding:10px 8px;text-align:center;color:var(--accent);font-weight:700;font-size:.9rem;text-transform:uppercase}
tbody td{padding:12px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.03);font-size:1rem}
tbody tr:nth-child(odd){background:rgba(255,255,255,0.01)}
.ramp-col{width:84px;font-weight:800;color:var(--accent)}
.status{display:inline-block;padding:8px 12px;border-radius:999px;font-weight:700;color:#071018;min-width:120px}
.status.loading{background:var(--loading);animation:flashLoading 1.2s linear infinite}
.status.un-loading{background:var(--unloading);animation:softPulse 2.6s ease-in-out infinite}
.status.standby-load{background:var(--standby)}
.status.standby-depart{background:var(--standby-dep)}
.status.anchorage{background:var(--anchorage);color:#fff;opacity:.92}
@keyframes flashLoading{0%,100%{opacity:1}50%{opacity:.35}}
@keyframes softPulse{0%,100%{box-shadow:0 0 8px rgba(43,155,230,0.12)}50%{box-shadow:0 0 20px rgba(43,155,230,0.26)}}
#toastWrap{position:fixed;top:18px;right:18px;display:flex;flex-direction:column;gap:10px;z-index:9999}
.toast{min-width:260px;background:var(--toast-bg);color:var(--white);padding:10px 14px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.5);display:flex;gap:12px;align-items:center;opacity:0;transform:translateY(-8px);transition:all .32s}
.toast.show{opacity:1;transform:translateY(0)}
footer{padding:8px 12px;text-align:center;color:var(--muted);font-size:.9rem;background:var(--header);border-top:2px solid var(--accent)}
</style>
</head>
<body>

<header>
  <h1>TMO-Matnog — Vessel Dashboard (Live)</h1>
  <div class="controls"><button id="refreshBtn">🔄 Refresh</button></div>
</header>

<main>
  <section class="panel">
    <div class="title">Active Vessels at Berth</div>
    <div class="content">
      <table>
        <thead><tr><th class="ramp-col">Ramp</th><th>Vessel</th><th>Shipping Lines</th><th>Last Port</th><th>Next Port</th><th>ETA</th><th>ETD</th><th>Status</th></tr></thead>
        <tbody id="activeBody"><tr><td colspan="6" style="opacity:.6">Loading...</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class="panel">
    <div class="title">Incoming Vessels</div>
    <div class="content">
      <table>
        <thead><tr><th>Vessel</th><th>Shipping Lines</th><th>Origin</th><th>Destination</th><th>ETA</th></tr></thead>
        <tbody id="incomingBody"><tr><td colspan="5" style="opacity:.6">Loading...</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<div id="toastWrap"></div>
<footer>⛴ Data source: OneDrive Excel (auto-refresh every 2 min)</footer>

<script>
const jsonURL = "https://my-json-proxy.YOURACCOUNT.workers.dev";
let lastRampJSON = null;
let lastIncomingJSON = null;

async function fetchJSONData() {
  try {
    showToast("Fetching latest data...", "⏳");

    const fullURL = `${jsonURL}?nocache=${Date.now()}`;
    const res = await fetch(fullURL, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to fetch JSON file");

    const data = await res.json();
    const rampRows = data.latestRampOccupants || [];
    const incomingRows = data.incomingVessels || [];

    // Only update if data changed
    if (JSON.stringify(rampRows) !== JSON.stringify(lastRampJSON) ||
        JSON.stringify(incomingRows) !== JSON.stringify(lastIncomingJSON)) {
      updateDashboard(rampRows, incomingRows);
      lastRampJSON = rampRows;
      lastIncomingJSON = incomingRows;
      showToast("Dashboard updated ✅", "📊");
    } else {
      console.log("No changes, skipping DOM update.");
    }
  } catch (err) {
    console.error("❌ Fetch error:", err);
    showToast("Error loading live data", "⚠️");
  }
}

function updateDashboard(rampRows, incomingRows) {
  const activeBody = document.getElementById("activeBody");
  const incomingBody = document.getElementById("incomingBody");

  // Use DocumentFragment for smoother updates
  const activeFrag = document.createDocumentFragment();
  const incomingFrag = document.createDocumentFragment();

  rampRows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="ramp-col">${r["Ramp Num"] || "—"}</td>
      <td>${r["Vessel Name"] || "—"}</td>
      <td>${r["Shipping Lines"] || "—"}</td>
      <td>${r["Last Port"] || "—"}</td>
      <td>${r["Next Port"] || "—"}</td>
      <td>${r["ETA"] || "—"}</td>
      <td>${r["ETD"] || "—"}</td>
      <td><span class="status ${r["Status"]?.toLowerCase().replace(/\s+/g, '-') || ''}">${r["Status"] || "—"}</span></td>
    `;
    activeFrag.appendChild(tr);
  });

  incomingRows.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r["Vessel Name"] || "—"}</td>
      <td>${r["Shipping Lines"] || "—"}</td>
      <td>${r["Last Port"] || "—"}</td>
      <td>${r["Next Port"] || "—"}</td>
      <td>${r["ETA"] || "—"}</td>
    `;
    incomingFrag.appendChild(tr);
  });

  // Clear old rows and append new ones
  activeBody.innerHTML = "";
  incomingBody.innerHTML = "";
  activeBody.appendChild(activeFrag);
  incomingBody.appendChild(incomingFrag);
}

// Manual refresh button
document.getElementById("refreshBtn").addEventListener("click", fetchJSONData);

// Auto-refresh every 5 seconds
fetchJSONData();
setInterval(fetchJSONData, 5000);

</script>
